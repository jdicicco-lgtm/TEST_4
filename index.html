<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Flotta & Prenotazioni</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    html[data-theme="dark"] {
      --bg-main: #0c0f14;
      --bg-card: #11161f;
      --bg-sidebar: #0f141c;
      --border-subtle: #2a3242;
      --text-primary: #eef2ff;
      --text-muted: #94a3b8;
      --c-flotta: #3b82f6;
      --c-costo: #06b6d4;
      --c-revenue: #22c55e;
      --shadow-strong: 0 18px 45px rgba(0,0,0,0.55);
      --shadow-soft: 0 12px 30px rgba(0,0,0,0.45);
    }

    html[data-theme="light"] {
      --bg-main: #f5f7fa;
      --bg-card: #ffffff;
      --bg-sidebar: #ffffff;
      --border-subtle: #d0d7e2;
      --text-primary: #1e293b;
      --text-muted: #64748b;
      --c-flotta: #2563eb;
      --c-costo: #0891b2;
      --c-revenue: #16a34a;
      --shadow-strong: 0 8px 20px rgba(0,0,0,0.08);
      --shadow-soft: 0 4px 10px rgba(0,0,0,0.06);
    }

    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      padding: 1.2rem;
    }

    .dashboard-shell { max-width: 1600px; margin: 0 auto; }
    .dashboard-header { padding-bottom: 1rem; border-bottom: 1px solid var(--border-subtle); margin-bottom: 1.2rem; }
    .sidebar { background: var(--bg-sidebar); padding: 1rem; border-radius: 1rem; border: 1px solid var(--border-subtle); box-shadow: var(--shadow-soft); }

    .kpi-card {
      background: var(--bg-card);
      padding: 1rem;
      border-radius: 1rem;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-strong);
    }

    .chart-container {
      background: var(--bg-card);
      padding: 1rem;
      border-radius: 1rem;
      border: 1px solid var(--border-subtle);
      height: 48vh;
      max-height: 480px;
      box-shadow: var(--shadow-strong);
    }
  </style>
</head>
  <body>
  <div class="dashboard-shell">

    <div class="dashboard-header d-flex justify-content-between align-items-center">
      <div>
        <h3 class="mb-0">Dashboard Flotta & Prenotazioni</h3>
        <small class="text-muted">Analisi 2024â€“2026 â€” Tema Neon Dual Mode</small>
      </div>
      <div><span id="themeToggle" style="cursor:pointer;">ðŸŒ™</span></div>
    </div>
<script>
// =========================
// GLOBAL VARS
// =========================
let fleetData = [];
let bookingsData = [];
let stationsData = [];

let monthly = [];
let baseMonthly = [];

let lineChart = null;
let barChart = null;

const GROUPS = [
  "Commercial Van","Large","Economy","Small","Mini",
  "Premium","Suv","People Mover","Station Wagon","Cabriolet"
];

const MONTHS_IT = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];

// =========================
// HELPERS
// =========================
function toNum(v){
  const n = parseFloat(String(v).replace(",","."));
  return isNaN(n) ? 0 : n;
}

function parseEUDate(s){
  if (!s) return null;
  s = String(s).trim();

  if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)){
    const [d,m,y] = s.split("/");
    const dt = new Date(+y, +m-1, +d);
    return isNaN(dt) ? null : dt;
  }
  const dt = new Date(s);
  return isNaN(dt) ? null : dt;
}

function ym(y,m){ return `${y}-${String(m).padStart(2,"0")}`; }
function idx(y,m){ return (y-2024)*12 + (m-1); }

function canonicalGroup(raw){
  if (!raw) return null;
  let s = String(raw).trim();
  const up = s.toUpperCase();

  const map = {
    "FURGONE":"Commercial Van",
    "VAN":"People Mover",
    "COMMERCIAL VAN":"Commercial Van",
    "COMM VAN":"Commercial Van",
    "PEOPLE MOVER":"People Mover",
    "PEOPLEMOVER":"People Mover",
    "STATION":"Station Wagon",
    "STATION WAGON":"Station Wagon"
  };

  if (map[up]) return map[up];
  if (GROUPS.includes(s)) return s;
  return null;
}

function normStation(s){
  if (!s) return null;
  const t = String(s).trim().toLowerCase();
  return t.charAt(0).toUpperCase()+t.slice(1);
}

// =========================
// LOAD DATA
// =========================
document.addEventListener("DOMContentLoaded", async ()=>{
  await loadData();
  initFilters();
  applyFilters();
});

async function loadData(){
  const f1 = await fetch("fleetDataclean.json").then(r=>r.json());
  const f2 = await fetch("bookings2025.json").then(r=>r.json());
  const f3 = await fetch("fleetStations2025.json").then(r=>r.json());
  fleetData = f1;
  bookingsData = f2;
  stationsData = f3;
}
// =========================
// FILTERS
// =========================
function initFilters(){
  const msel = monthFilter;
  msel.append(new Option("Tutti","ALL",true,true));
  MONTHS_IT.forEach((m,i)=> msel.append(new Option(m,String(i+1))));

  const gsel = groupFilter;
  gsel.append(new Option("Tutti","ALL",true,true));
  GROUPS.forEach(g=> gsel.append(new Option(g,g)));

  const asel = acquisitionFilter;
  asel.append(new Option("Tutti","ALL",true,true));

  const setA = new Set();
  fleetData.forEach(r=>{ if(r.ACQUISIZIONE) setA.add(r.ACQUISIZIONE.trim()); });
  bookingsData.forEach(r=>{ if(r.acquisizione) setA.add(r.acquisizione.trim()); });
  [...setA].sort().forEach(a=> asel.append(new Option(a,a)));

  const ssel = stationFilter;
  ssel.append(new Option("Tutti","ALL",true,true));
  const setS = new Set();
  stationsData.forEach(r=>{ if(r.station) setS.add(normStation(r.station)); });
  bookingsData.forEach(r=>{ if(r.stazione) setS.add(normStation(r.stazione)); });
  [...setS].sort().forEach(a=> ssel.append(new Option(a,a)));

  ["yearFilter","monthFilter","groupFilter","acquisitionFilter","stationFilter","projectionSelect"]
    .forEach(id=> document.getElementById(id).addEventListener("change", applyFilters));

  clearFiltersBtn.onclick = resetFilters;
}

function getMulti(id){
  const sel = [...document.getElementById(id).selectedOptions].map(o=>o.value);
  return sel.includes("ALL") ? [] : sel;
}

function resetFilters(){
  ["yearFilter","monthFilter","groupFilter","acquisitionFilter","stationFilter"]
    .forEach(id=>{
      const el = document.getElementById(id);
      [...el.options].forEach(o=> o.selected = (o.value==="ALL"));
    });
  projectionSelect.value = "0.10";
  applyFilters();
}
// =========================
// CORE AGGREGATION
// =========================
function applyFilters(){
  const years = getMulti("yearFilter").map(Number);
  const months = getMulti("monthFilter").map(Number);
  const groups = getMulti("groupFilter");
  const acq = getMulti("acquisitionFilter");
  const stations = getMulti("stationFilter");
  const proj = parseFloat(projectionSelect.value);

  baseMonthly = aggregateAll({groups,acq,stations,proj});
  monthly = baseMonthly.filter(b=>{
    const okY = !years.length || years.includes(b.year);
    const okM = !months.length || months.includes(b.month);
    return okY && okM;
  });

  updateKPI();
  updateCharts();
}

// =========================
// KPI CORRETTI
// =========================
function updateKPI(){
  if (!monthly.length){ resetKPI(); return; }

  const idxs = monthly.map(b=>idx(b.year,b.month));
  const min = Math.min(...idxs);
  const max = Math.max(...idxs);
  const span = max-min+1;

  const prevEnd = min-1;
  let prevStart = prevEnd-(span-1);
  if (prevStart < 0) prevStart = 0;
  const hasPrev = prevEnd >= 0;

  const curr = sumRange(min,max);
  const prev = hasPrev ? sumRange(prevStart,prevEnd) : null;

  setK("kpi-fleet", curr.fleet/span, prev ? prev.fleet/span : 0);
  setK("kpi-canone", curr.canImp,   prev ? prev.canImp : 0, true);
  setK("kpi-assicurazione", curr.ass, prev ? prev.ass : 0, true);
  setK("kpi-costo", curr.costo, prev ? prev.costo : 0, true);
  setK("kpi-revenue", curr.revenue, prev ? prev.revenue : 0, true);
  setK("kpi-revday", curr.revDay, prev ? prev.revDay : 0, true);
  setK("kpi-bookings", curr.bookings, prev ? prev.bookings : 0);
  setK("kpi-noleggiati", curr.rented/span, prev ? prev.rented/span : 0);
}

function sumRange(i1,i2){
  const out = {
    fleet:0, canImp:0, canIva:0, ass:0, costo:0,
    revenue:0, revDays:0, bookings:0, rented:0, revDay:0
  };

  baseMonthly.forEach(b=>{
    const ix = idx(b.year,b.month);
    if (ix>=i1 && ix<=i2){
      out.fleet += b.fleet;
      out.canImp += b.canImp;
      out.canIva += b.canIva;
      out.ass += b.ass;
      out.costo += b.costo;
      out.revenue += b.revenue;
      out.revDays += b.revDays;
      out.bookings += b.bookings;
      out.rented += b.rented;
    }
  });

  out.revDay = out.revDays ? out.revenue/out.revDays : 0;
  return out;
}

// =========================
// setK CORRETTO
// =========================
function setK(id,val,prev,isCur=false){
  const c = document.getElementById(id+"-current");
  const p = document.getElementById(id+"-prev");
  const d = document.getElementById(id+"-diff");

  c.textContent = isCur ? "â‚¬ "+val.toLocaleString("it-IT") 
                        : val.toLocaleString("it-IT");

  p.textContent = prev ? (isCur ? "â‚¬ "+prev.toLocaleString("it-IT") 
                                : prev.toLocaleString("it-IT"))
                       : "â€“";

  d.classList.remove("positive","negative","neutral");

  if (!prev){
    d.textContent="â†”ï¸Ž 0%";
    d.classList.add("neutral");
    return;
  }

  const diff = ((val-prev)/prev)*100;

  if (diff>0){
    d.textContent="ðŸ“ˆ "+diff.toFixed(1)+"%";
    d.classList.add("positive");
  } else if (diff<0){
    d.textContent="ðŸ“‰ "+diff.toFixed(1)+"%";
    d.classList.add("negative");
  } else {
    d.textContent="â†”ï¸Ž 0%";
    d.classList.add("neutral");
  }
}

function resetKPI(){
  [
    "kpi-fleet","kpi-canone","kpi-assicurazione","kpi-costo",
    "kpi-revenue","kpi-revday","kpi-bookings","kpi-noleggiati"
  ].forEach(id=>{
    document.getElementById(id+"-current").textContent="â€“";
    document.getElementById(id+"-prev").textContent="â€“";
    const d=document.getElementById(id+"-diff");
    d.textContent="â€“";
    d.className="kpi-diff neutral";
  });
}

// =========================
// CHARTS
// =========================
function updateCharts(){
  if (!monthly.length){
    lineChart && lineChart.destroy();
    barChart && barChart.destroy();
    return;
  }

  const labels = monthly.map(b=>b.label);
  const fl = monthly.map(b=>b.fleet);
  const cost = monthly.map(b=>b.costo);
  const rev = monthly.map(b=>b.revenue);

  const max1 = Math.max(...fl)*1.2;
  const max2 = Math.max(...cost,...rev)*1.2;

  lineChart && lineChart.destroy();
  barChart && barChart.destroy();

  lineChart = new Chart(lineChart.getContext("2d"),{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Flotta",data:fl,borderColor:"#3b82f6",yAxisID:"y"},
        {label:"Costo totale",data:cost,borderColor:"#f87171",yAxisID:"y1"},
        {label:"Revenue",data:rev,borderColor:"#22c55e",yAxisID:"y1"}
      ]
    },
    options:{
      interaction:{mode:"index",intersect:false},
      scales:{
        y:{beginAtZero:true,max:max1},
        y1:{beginAtZero:true,max:max2,position:"right",grid:{drawOnChartArea:false}}
      }
    }
  });

  barChart = new Chart(barChart.getContext("2d"),{
    type:"bar",
    data:{
      labels,
      datasets:[
        {label:"Costo totale",data:cost, backgroundColor:"rgba(248,113,113,.5)"},
        {label:"Revenue",data:rev, backgroundColor:"rgba(34,197,94,.5)"}
      ]
    },
    options:{
      interaction:{mode:"index",intersect:false},
      scales:{y:{beginAtZero:true,max:max2}}
    }
  });
}
</script>
<script>
document.getElementById("themeToggle").onclick = ()=>{
  const html = document.documentElement;
  const now = html.getAttribute("data-theme")==="dark" ? "light":"dark";
  html.setAttribute("data-theme",now);
  localStorage.setItem("dashboard-theme",now);
  themeToggle.textContent = (now==="dark"?"ðŸŒ™":"ðŸŒž");
};

(function(){
  const saved = localStorage.getItem("dashboard-theme") || "dark";
  document.documentElement.setAttribute("data-theme", saved);
  themeToggle.textContent = (saved==="dark"?"ðŸŒ™":"ðŸŒž");
})();
</script>

</body>
</html>

