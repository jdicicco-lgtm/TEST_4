<head>
  <meta charset="UTF-8" />
  <title>Dashboard Flotta & Prenotazioni</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet" crossorigin="anonymous" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg-main: #0f1115;
      --bg-card: #1a1f29;
      --bg-sidebar: #141821;
      --border-subtle: #2d3341;

      /* PALETTE A ‚Äî Blu / Ciano / Verde */
      --c-flotta: #3b82f6;     /* blu */
      --c-costo: #06b6d4;      /* ciano */
      --c-revenue: #22c55e;    /* verde */

      --text-primary: #f5f5f7;
      --text-muted: #9ca3af;

      --success: #22c55e;
      --danger: #ef4444;
    }

    body {
      background: radial-gradient(circle at top, #1e293b 0, #020617 60%);
      color: var(--text-primary);
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      min-height: 100vh;
    }

    .dashboard-shell { padding: 1.5rem 1rem; }

    .dashboard-header {
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(148,163,184,0.25);
      margin-bottom: 1rem;
    }

    /* SIDEBAR */
    .sidebar {
      background: var(--bg-sidebar);
      padding: 1rem;
      border-radius: 1rem;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
    }

    .sidebar-title {
      font-size: .9rem;
      font-weight: 600;
      letter-spacing: .08em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .filter-label {
      font-size: .75rem;
      color: var(--text-muted);
      margin-bottom: .15rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .form-select {
      background-color: #0b1120;
      color: var(--text-primary);
      border: 1px solid #2b3344;
      font-size: .85rem;
    }

    .form-select:focus {
      border-color: var(--c-flotta);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.25);
    }

    .accordion-button {
      background: #0b1120;
      color: var(--text-primary);
      font-size: .8rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      border-bottom: 1px solid var(--border-subtle);
    }

    .accordion-button:not(.collapsed) {
      color: var(--c-flotta);
      background: #0b1120;
      box-shadow: none;
    }

    /* KPI */
    .kpi-card {
      background: var(--bg-card);
      border-radius: 1rem;
      padding: 1rem;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 16px 35px rgba(0,0,0,0.45);
    }

    .kpi-title {
      font-size: .78rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .08em;
      margin-bottom: .25rem;
    }

    .kpi-value {
      font-size: 1.45rem;
      font-weight: 700;
      margin-bottom: .25rem;
    }

    .kpi-prev {
      font-size: .75rem;
      color: var(--text-muted);
    }

    .kpi-diff {
      font-size: .85rem;
      font-weight: 700;
    }

    .kpi-diff.positive { color: var(--success); }
    .kpi-diff.negative { color: var(--danger); }
    .kpi-diff.neutral  { color: var(--text-muted); }

    /* GRAFICI */
    .chart-container {
      background: #0f1623;
      border-radius: 1rem;
      padding: 1.2rem;
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
      border: 1px solid var(--border-subtle);
      height: 45vh;
      max-height: 480px;
    }

    @media print {
      body { background: #fff; color: #000; }
      .sidebar, .kpi-card, .chart-container {
        background: #fff !important;
        box-shadow: none !important;
        border-color: #ccc !important;
        color: #000 !important;
      }
    }
  </style>
</head>
<body>
  <div class="container-fluid dashboard-shell">

    <!-- HEADER -->
    <div class="dashboard-header d-flex justify-content-between align-items-center">
      <div>
        <h3 class="mb-0">Dashboard Flotta & Prenotazioni</h3>
        <small class="text-muted">Analisi flotta 2024‚Äì2026 + prenotazioni 2025</small>
      </div>

      <div class="no-print">
        <button id="exportCsvBtn" class="btn btn-outline-secondary btn-sm me-2">
          ‚¨áÔ∏è Esporta CSV
        </button>
        <button id="printPdfBtn" class="btn btn-outline-secondary btn-sm">
          üñ®Ô∏è Stampa / PDF
        </button>
      </div>
    </div>

    <div class="row g-3">

      <!-- ------------------------- -->
      <!-- SIDEBAR FILTRI           -->
      <!-- ------------------------- -->
      <div class="col-12 col-lg-3 no-print">
        <div class="sidebar">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="sidebar-title">Filtri</div>
            <button id="clearFiltersBtn" class="btn btn-outline-danger btn-sm">
              üîÑ Reset
            </button>
          </div>

          <div class="accordion accordion-flush" id="filtersAccordion">

            <!-- Anno -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseYear">
                  Anno
                </button>
              </h2>
              <div id="collapseYear" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <label class="filter-label">Anno</label>
                  <select id="yearFilter" class="form-select form-select-sm" multiple>
                    <option value="ALL" selected>Tutti</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Mese -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseMonth">
                  Mese
                </button>
              </h2>
              <div id="collapseMonth" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <label class="filter-label">Mese</label>
                  <select id="monthFilter" class="form-select form-select-sm" multiple></select>
                </div>
              </div>
            </div>

            <!-- Gruppo -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseGroup">
                  Gruppo veicolo
                </button>
              </h2>
              <div id="collapseGroup" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <label class="filter-label">Gruppo</label>
                  <select id="groupFilter" class="form-select form-select-sm" multiple></select>
                </div>
              </div>
            </div>

            <!-- Acquisizione -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseAcq">
                  Acquisizione
                </button>
              </h2>
              <div id="collapseAcq" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <label class="filter-label">Acquisizione</label>
                  <select id="acquisitionFilter" class="form-select form-select-sm" multiple></select>
                </div>
              </div>
            </div>

            <!-- Stazione -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseStation">
                  Stazione
                </button>
              </h2>
              <div id="collapseStation" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <label class="filter-label">Stazione</label>
                  <select id="stationFilter" class="form-select form-select-sm" multiple></select>
                </div>
              </div>
            </div>

            <!-- Proiezioni -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapseProjection">
                  Proiezione 2026
                </button>
              </h2>
              <div id="collapseProjection" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <label class="filter-label">Proiezione</label>
                  <select id="projectionSelect" class="form-select form-select-sm">
                    <option value="0.05">+5%</option>
                    <option value="0.10" selected>+10%</option>
                    <option value="0.15">+15%</option>
                    <option value="0.20">+20%</option>
                  </select>
                  <small class="text-muted d-block mt-1" style="font-size:.7rem">
                    Applicata sui dati 2026 ricostruiti dal 2025.
                  </small>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- ------------------------- -->
      <!-- KPI & GRAFICI            -->
      <!-- ------------------------- -->
      <div class="col-12 col-lg-9">

        <!-- KPI ROW 1 -->
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6 col-xl-3">
            <div class="kpi-card">
              <div class="kpi-title">üöó Flotta (media)</div>
              <div class="kpi-value" id="kpi-fleet-current">‚Äì</div>
              <div class="kpi-prev">Prev: <span id="kpi-fleet-prev">‚Äì</span></div>
              <div id="kpi-fleet-diff" class="kpi-diff neutral">‚Äì</div>
            </div>
          </div>

          <div class="col-12 col-md-6 col-xl-3">
            <div class="kpi-card">
              <div class="kpi-title">üí∂ Canone imponibile</div>
              <div class="kpi-value" id="kpi-canone-current">‚Äì</div>
              <div class="kpi-prev">Prev: <span id="kpi-canone-prev">‚Äì</span></div>
              <div id="kpi-canone-diff" class="kpi-diff neutral">‚Äì</div>
              <div class="kpi-prev">
                Ivato: <span id="kpi-canone-ivato-current">‚Äì</span>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6 col-xl-3">
            <div class="kpi-card">
              <div class="kpi-title">üõ°Ô∏è Assicurazione</div>
              <div class="kpi-value" id="kpi-assicurazione-current">‚Äì</div>
              <div class="kpi-prev">Prev: <span id="kpi-assicurazione-prev">‚Äì</span></div>
              <div id="kpi-assicurazione-diff" class="kpi-diff neutral">‚Äì</div>
            </div>
          </div>

          <div class="col-12 col-md-6 col-xl-3">
            <div class="kpi-card">
              <div class="kpi-title">üí∞ Costo totale</div>
              <div class="kpi-value" id="kpi-costo-current">‚Äì</div>
              <div class="kpi-prev">Prev: <span id="kpi-costo-prev">‚Äì</span></div>
              <div id="kpi-costo-diff" class="kpi-diff neutral">‚Äì</div>
            </div>
          </div>
        </div>

        <!-- KPI ROW 2 -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-md-6 col-xl-3">
            <div class="kpi-card">
              <div class="kpi-title">üí∏ Revenue</div>
              <div class="kpi-value" id="kpi-revenue-current">‚Äì</div>
              <div class="kpi-prev">Prev: <span id="kpi-revenue-prev">‚Äì</span></div>
              <div id="kpi-revenue-diff" class="kpi-diff neutral">‚Äì</div>
            </div>
          </div>

          <div class="col-12 col-md-6 col-xl-3">
            <div class="kpi-card">
              <div class="kpi-title">‚òÄÔ∏è Revenue/day</div>
              <div class="kpi-value" id="kpi-revday-current">‚Äì</div>
              <div class="kpi-prev">Prev: <span id="kpi-revday-prev">‚Äì</span></div>
              <div id="kpi-revday-diff" class="kpi-diff neutral">‚Äì</div>
            </div>
          </div>

          <div class="col-12 col-md-6 col-xl-3">
            <div class="kpi-card">
              <div class="kpi-title">üìù Prenotazioni</div>
              <div class="kpi-value" id="kpi-bookings-current">‚Äì</div>
              <div class="kpi-prev">Prev: <span id="kpi-bookings-prev">‚Äì</span></div>
              <div id="kpi-bookings-diff" class="kpi-diff neutral">‚Äì</div>
            </div>
          </div>

          <div class="col-12 col-md-6 col-xl-3">
            <div class="kpi-card">
              <div class="kpi-title">üöô Noleggiati (media)</div>
              <div class="kpi-value" id="kpi-noleggiati-current">‚Äì</div>
              <div class="kpi-prev">Prev: <span id="kpi-noleggiati-prev">‚Äì</span></div>
              <div id="kpi-noleggiati-diff" class="kpi-diff neutral">‚Äì</div>
            </div>
          </div>
        </div>

        <!-- ===================== -->
        <!-- GRAFICO LINEA MODERNO -->
        <!-- ===================== -->
        <div class="chart-container mb-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Andamento flotta & costi</h6>
            <small class="text-muted">Flotta, costo totale, revenue</small>
          </div>
          <canvas id="lineChart"></canvas>
        </div>

        <!-- ======================== -->
        <!-- GRAFICO BARRE MODERNO   -->
        <!-- ======================== -->
        <div class="chart-container mb-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Confronto costi vs revenue</h6>
          </div>
          <canvas id="barChart"></canvas>
        </div>

      </div> <!-- /col-lg-9 -->

    </div> <!-- /row -->
  </div><!-- /dashboard-shell -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          crossorigin="anonymous"></script>

<script>
// =========================
// GLOBAL CHART STATE
// =========================
let lineChart = null;
let barChart  = null;

function safeNumber(v) {
  if (!Number.isFinite(v) || isNaN(v)) return 0;
  return v;
}

// =========================
// CONFIG & GLOBAL STATE
// =========================
const VEHICLE_GROUPS = [
  "Commercial Van","Large","Economy","Small","Mini",
  "Premium","Suv","People Mover","Station Wagon","Cabriolet"
];

const RAW_GROUP_MAP = {
  "COMMERCIAL VAN":"Commercial Van", "COMM VAN":"Commercial Van", "COMMERCIALVAN":"Commercial Van",
  "LARGE":"Large","ECONOMY":"Economy","SMALL":"Small","MINI":"Mini","PREMIUM":"Premium","SUV":"Suv",
  "PEOPLE MOVER":"People Mover","PEOPLEMOVER":"People Mover",
  "STATION":"Station Wagon","STATION WAGON":"Station Wagon",
  "CABRIOLET":"Cabriolet","CABRIO":"Cabriolet"
};

function canonicalGroup(raw) {
  if (raw == null) return null;
  let s = String(raw).trim();
  if (!s || s.toLowerCase() === "nan") return null;

  const up = s.toUpperCase();
  if (RAW_GROUP_MAP[up]) return RAW_GROUP_MAP[up];
  if (VEHICLE_GROUPS.includes(s)) return s;

  return null;
}

const MONTH_LABELS_IT = [
  "Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno",
  "Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"
];

let fleetData = [];
let fleetStationsData = [];
let bookingsData = [];

let baseAggregates = [];
let monthlyAggregates = [];

// =========================
// INIT
// =========================
document.addEventListener("DOMContentLoaded", () => {
  initMonthsFilter();
  initGroupFilter();

  loadData().then(() => {
    initAcquisitionFilter();
    initStationFilter();
    initFilterEvents();
    applyFiltersAndRender();
  });

  document.getElementById("clearFiltersBtn").onclick = resetFilters;
  document.getElementById("exportCsvBtn").onclick = exportCsv;
  document.getElementById("printPdfBtn").onclick = () => window.print();
});

// =========================
// LOADING DATA
// =========================
async function loadData() {
  try {
    const [fleetRes, stationsRes, bookingsRes] = await Promise.all([
      fetch("fleetData_clean.json"),
      fetch("fleetStations2025.json"),
      fetch("bookings2025.json")
    ]);

    fleetData = await fleetRes.json();
    fleetStationsData = await stationsRes.json();
    bookingsData = await bookingsRes.json();

  } catch (err) {
    console.error("Errore JSON:", err);
    alert("Errore nel caricamento dei file JSON.");
  }
}

// =========================
// FILTERS
// =========================
function initMonthsFilter() {
  const el = document.getElementById("monthFilter");
  const optAll = new Option("Tutti","ALL",true,true);
  el.appendChild(optAll);

  MONTH_LABELS_IT.forEach((label,idx)=>{
    el.appendChild(new Option(label, String(idx+1).padStart(2,"0")));
  });
}

function initGroupFilter() {
  const el = document.getElementById("groupFilter");
  el.appendChild(new Option("Tutti","ALL",true,true));
  VEHICLE_GROUPS.forEach(g => el.appendChild(new Option(g,g)));
}

function cleanValue(v) {
  if (v == null) return null;
  const s = String(v).trim();
  if (!s || s.toLowerCase() === "nan") return null;
  return s;
}

function initAcquisitionFilter() {
  const el = document.getElementById("acquisitionFilter");
  el.innerHTML = "";
  el.appendChild(new Option("Tutti","ALL",true,true));

  const set = new Set();

  fleetData.forEach(r => { const v = cleanValue(r["ACQUISIZIONE"]); if (v) set.add(v); });
  bookingsData.forEach(r => { const v = cleanValue(r["acquisizione"]); if (v) set.add(v); });

  [...set].sort().forEach(v => el.appendChild(new Option(v,v)));
}

function normalizeStationName(n) {
  if (!n) return null;
  const s = String(n).trim().toLowerCase();
  if (!s) return null;
  return s.charAt(0).toUpperCase() + s.slice(1);
}

function initStationFilter() {
  const el = document.getElementById("stationFilter");
  el.innerHTML = "";
  el.appendChild(new Option("Tutti","ALL",true,true));

  const set = new Set();

  fleetStationsData.forEach(r => {
    const v = normalizeStationName(r.station);
    if (v) set.add(v);
  });

  bookingsData.forEach(r => {
    const v = normalizeStationName(r.stazione);
    if (v) set.add(v);
  });

  [...set].sort().forEach(v => el.appendChild(new Option(v,v)));
}

function initFilterEvents() {
  ["yearFilter","monthFilter","groupFilter","acquisitionFilter","stationFilter","projectionSelect"]
    .forEach(id=>{
      const el = document.getElementById(id);
      el && el.addEventListener("change", applyFiltersAndRender);
    });
}

function getMulti(id) {
  const el = document.getElementById(id);
  if (!el) return [];
  const sel = [...el.selectedOptions].map(o=>o.value);
  if (sel.includes("ALL")) return [];
  return sel;
}

function resetFilters() {
  ["yearFilter","monthFilter","groupFilter","acquisitionFilter","stationFilter"].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    [...el.options].forEach(o => o.selected = (o.value==="ALL"));
  });
  document.getElementById("projectionSelect").value = "0.10";
  applyFiltersAndRender();
}

// =========================
// DATE HELPERS
// =========================
function parseDate(v) {
  if (!v) return null;
  if (typeof v === "number") {
    const d = new Date(v);
    return isNaN(d) ? null : d;
  }
  const s = String(v).trim();
  if (!s) return null;

  if (/^\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s);
  if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
    const [d,m,y] = s.split("/");
    return new Date(+y, +m-1, +d);
  }
  const d = new Date(s);
  return isNaN(d) ? null : d;
}

function formatYM(year,month){ return `${year}-${String(month).padStart(2,"0")}`; }

function idxGlobal(y,m){
  return (y - 2024)*12 + (m - 1);
}

// =========================
// CORE APPLY FILTERS
// =========================
function applyFiltersAndRender() {
  const years = getMulti("yearFilter").map(v=>+v);
  const months = getMulti("monthFilter").map(v=>+v);
  const groups = getMulti("groupFilter");
  const acq = getMulti("acquisitionFilter");
  const stations = getMulti("stationFilter");
  const proj = parseFloat(document.getElementById("projectionSelect").value);

  baseAggregates = computeMonthlyAggregates({ groups, acq, stations, proj });

  monthlyAggregates = baseAggregates.filter(b => {
    const y = (!years.length || years.includes(b.year));
    const m = (!months.length || months.includes(b.month));
    return y && m;
  });

  updateKPI();
  updateCharts();
}

// =========================
// AGGREGATIONS
// =========================
function computeMonthlyAggregates({groups,acq,stations,proj}) {

  const map = new Map();

  // init buckets
  for (let y=2024;y<=2026;y++){
    for (let m=1;m<=12;m++){
      const key = formatYM(y,m);
      map.set(key,{
        year:y, month:m, key,
        label: MONTH_LABELS_IT[m-1].slice(0,3)+" "+y,
        fleetSize:0, canoneImponibile:0, canoneIvato:0,
        assicurazione:0, costoTotale:0,
        revenue:0, revenueDays:0, revenuePerDay:0,
        numBookings:0,
        noleggiati:0
      });
    }
  }

  // ----- FLOTA -----
  fleetData.forEach(r=>{

    const g = canonicalGroup(r["GRUPPO"]);
    if (!g) return;
    if (groups.length && !groups.includes(g)) return;

    const aq = cleanValue(r["ACQUISIZIONE"]);
    if (acq.length && (!aq || !acq.includes(aq))) return;

    const start = parseDate(r["DATA INIZIO"]);
    const eff   = parseDate(r["RICONSEGNA EFFETTIVA"]);
    const end   = parseDate(r["DATA FINE"]) || eff;
    if (!start || !end) return;
    if (end < start) return;

    const canImp = parseFloat((r["CANONE IMPONIBILE"]||"0").toString().replace(",", "."))||0;
    const canIvato = parseFloat((r["CANONE IVATO"]||"0").toString().replace(",", "."))||0;
    const ass = parseFloat((r["COPERTURA ASS."]||"0").toString().replace(",", "."))||0;

    const sy = Math.max(2024,start.getFullYear());
    const ey = Math.min(2026,end.getFullYear());

    for (let y=sy;y<=ey;y++){
      const ms = (y===start.getFullYear()?start.getMonth()+1:1);
      const me = (y===end.getFullYear()?end.getMonth()+1:12);

      for (let m=ms;m<=me;m++){
        const b = map.get(formatYM(y,m));
        b.fleetSize++;
        b.canoneImponibile += canImp;
        b.canoneIvato += canIvato;
        b.assicurazione += ass;
        b.costoTotale += canImp + ass;
      }
    }
  });

  // ----- STATION FILTER ON FLEET -----
  applyStationFilter(map, groups, stations);

  // ----- BOOKINGS (2025) -----
  bookingsData.forEach(r=>{
    const g = canonicalGroup(r["cartype"] || r["gruppo"]);
    if (!g) return;
    if (groups.length && !groups.includes(g)) return;

    const st = normalizeStationName(r.stazione);
    if (stations.length && (!st || !stations.includes(st))) return;

    const aq = cleanValue(r["acquisizione"]);
    if (acq.length && (!aq || !acq.includes(aq))) return;

    const d = parseDate(r.startDate);
    if (!d) return;

    const y = d.getFullYear();
    const m = d.getMonth()+1;
    if (y<2024 || y>2026) return;

    const b = map.get(formatYM(y,m));
    if (!b) return;

    let days = parseFloat(r.duration||0); if (days<1) days=1;
    const price = parseFloat((r.price||"0").toString().replace(",", "."))||0;

    b.revenue += price;
    b.revenueDays += days;
    b.numBookings++;
  });

  // compute revenue/day + noleggiati
  map.forEach(b=>{
    b.revenuePerDay = b.revenueDays>0 ? b.revenue/b.revenueDays : 0;

    if (b.fleetSize>0 && b.revenueDays>0){
      const util = b.revenueDays/(b.fleetSize*30);
      b.noleggiati = util * b.fleetSize;
    }
  });

  // ---------- REBUILD 2024 (-5%) & 2026 BASE ----------
  for (let m=1;m<=12;m++){
    const mm = String(m).padStart(2,"0");
    const b24 = map.get(`2024-${mm}`);
    const b25 = map.get(`2025-${mm}`);
    const b26 = map.get(`2026-${mm}`);

    if (b25){
      if (b24){
        b24.revenue       = b25.revenue * 0.95;
        b24.revenueDays   = b25.revenueDays * 0.95;
        b24.numBookings   = b25.numBookings * 0.95;
        b24.noleggiati    = b25.noleggiati * 0.95;
        b24.revenuePerDay = b24.revenueDays>0 ? b24.revenue/b24.revenueDays : 0;
      }

      if (b26){
        b26.revenue       = b25.revenue;
        b26.revenueDays   = b25.revenueDays;
        b26.numBookings   = b25.numBookings;
        b26.noleggiati    = b25.noleggiati;
        b26.revenuePerDay = b26.revenueDays>0 ? b26.revenue/b26.revenueDays : 0;
      }
    }
  }

  // apply projection factor to 2026
  if (proj){
    map.forEach(b=>{
      if (b.year===2026){
        const f = (1+proj);
        b.fleetSize *= f;
        b.canoneImponibile *= f;
        b.canoneIvato *= f;
        b.assicurazione *= f;
        b.costoTotale *= f;
        b.revenue *= f;
        b.revenuePerDay *= f;
        b.numBookings *= f;
        b.noleggiati *= f;
      }
    });
  }

  return [...map.values()].sort((a,b)=>idxGlobal(a.year,a.month)-idxGlobal(b.year,b.month));
}

// =========================
// STATION FILTER (flotta)
// =========================
function applyStationFilter(map, groups, stations){
  if (!stations.length) return;
  const stats = new Map();

  fleetStationsData.forEach(r=>{
    const g = canonicalGroup(r.group);
    if (!g) return;
    if (groups.length && !groups.includes(g)) return;

    const st = normalizeStationName(r.station);
    if (!st) return;

    const y = +r.year;
    const m = +r.month;
    const key = formatYM(y,m);

    const fl = parseFloat((r.fleet||0).toString().replace(",", "."))||0;

    if (!stats.has(key)) stats.set(key,{all:0,selected:0});
    const s = stats.get(key);
    s.all += fl;
    if (stations.includes(st)) s.selected += fl;
  });

  map.forEach((b,key)=>{
    const s = stats.get(key);
    if (!s || s.all<=0 || s.selected<=0) return;
    const f = s.selected/s.all;
    b.fleetSize *= f;
    b.canoneImponibile *= f;
    b.canoneIvato *= f;
    b.assicurazione *= f;
    b.costoTotale *= f;
  });
}

// =========================
// KPI
// =========================
function updateKPI(){
  if (!monthlyAggregates.length){
    resetKPI();
    return;
  }

  const idxs = monthlyAggregates.map(b=>idxGlobal(b.year,b.month));
  const min = Math.min(...idxs);
  const max = Math.max(...idxs);
  const len = max - min + 1;

  const prevEnd = min - 1;
  const prevStart = prevEnd - (len - 1);

  function clamp(v){return Math.min(Math.max(v,0),35);}
  const prevS = clamp(prevStart);
  const prevE = clamp(prevEnd);

  function sumRange(start,end){
    const set = new Set();
    for (let i=start;i<=end;i++) set.add(i);

    const r={fleet:0, imp:0, ivato:0, ass:0, costo:0, rev:0, rdays:0, bookings:0, nol:0};

    baseAggregates.forEach(b=>{
      const idx = idxGlobal(b.year,b.month);
      if (set.has(idx)){
        r.fleet += b.fleetSize;
        r.imp += b.canoneImponibile;
        r.ivato += b.canoneIvato;
        r.ass += b.assicurazione;
        r.costo += b.costoTotale;
        r.rev += b.revenue;
        r.rdays += b.revenueDays;
        r.bookings += b.numBookings;
        r.nol += b.noleggiati;
      }
    });

    r.revday = (r.rdays>0 ? r.rev/r.rdays : 0);
    return r;
  }

  const curr = sumRange(min,max);
  const prev = sumRange(prevS,prevE);

  const currMonths = (max-min+1)||1;
  const prevMonths = (prevE-prevS+1)||1;

  const fleetCurr = curr.fleet/currMonths;
  const fleetPrev = prev.fleet/prevMonths;

  const nolCurr = curr.nol/currMonths;
  const nolPrev = prev.nol/prevMonths;

  function setK(id, currVal, prevVal, isCurrency=false, decimals=0){
    const ec = document.getElementById(id+"-current");
    const ep = document.getElementById(id+"-prev");
    const ed = document.getElementById(id+"-diff");
    if (!ec||!ep||!ed) return;

    const fmt = v => {
      if (!isFinite(v)) return "‚Äì";
      return isCurrency
        ? "‚Ç¨ "+ v.toLocaleString("it-IT",{minimumFractionDigits:decimals, maximumFractionDigits:decimals})
        : v.toLocaleString("it-IT",{minimumFractionDigits:decimals, maximumFractionDigits:decimals});
    };

    ec.textContent = fmt(currVal);
    ep.textContent = prevVal ? fmt(prevVal) : "‚Äì";

    let diff = null;
    if (prevVal && prevVal!==0) diff = ((currVal-prevVal)/prevVal)*100;

    ed.classList.remove("positive","negative","neutral");

    if (diff===null){
      ed.textContent = "‚ÜîÔ∏é 0%";
      ed.classList.add("neutral");
    } else if (diff>0){
      ed.textContent = "üìà "+diff.toFixed(1)+"%";
      ed.classList.add("positive");
    } else if (diff<0){
      ed.textContent = "üìâ "+diff.toFixed(1)+"%";
      ed.classList.add("negative");
    } else {
      ed.textContent = "‚ÜîÔ∏é 0%";
      ed.classList.add("neutral");
    }
  }

  // KPI
  setK("kpi-fleet", fleetCurr, fleetPrev, false, 1);
  setK("kpi-canone", curr.imp, prev.imp, true, 0);

  document.getElementById("kpi-canone-ivato-current").textContent =
    curr.ivato ? "‚Ç¨ "+curr.ivato.toLocaleString("it-IT") : "‚Äì";

  setK("kpi-assicurazione", curr.ass, prev.ass, true, 0);
  setK("kpi-costo", curr.costo, prev.costo, true, 0);
  setK("kpi-revenue", curr.rev, prev.rev, true, 0);
  setK("kpi-revday", curr.revday, prev.revday, true, 2);
  setK("kpi-bookings", curr.bookings, prev.bookings, false, 0);
  setK("kpi-noleggiati", nolCurr, nolPrev, false, 1);
}

function resetKPI(){
  [
    "kpi-fleet","kpi-canone","kpi-assicurazione","kpi-costo",
    "kpi-revenue","kpi-revday","kpi-bookings","kpi-noleggiati"
  ].forEach(id=>{
    document.getElementById(id+"-current").textContent="‚Äì";
    document.getElementById(id+"-prev").textContent="‚Äì";
    let d = document.getElementById(id+"-diff");
    if (d){
      d.textContent="‚Äì";
      d.classList.add("neutral");
    }
  });
}

// =========================
// CHARTS
// =========================
function updateCharts(){
  const lc = document.getElementById("lineChart");
  const bc = document.getElementById("barChart");
  if (!lc || !bc) return;

  if (!monthlyAggregates.length){
    lineChart && lineChart.destroy();
    barChart && barChart.destroy();
    return;
  }

  const labels = monthlyAggregates.map(b=>b.label);
  const fleet  = monthlyAggregates.map(b=>safeNumber(b.fleetSize));
  const cost   = monthlyAggregates.map(b=>safeNumber(b.costoTotale));
  const rev    = monthlyAggregates.map(b=>safeNumber(b.revenue));

  const maxY1 = Math.max(...fleet)*1.2 || 1;
  const maxY2 = Math.max(...cost, ...rev)*1.2 || 1;

  lineChart && lineChart.destroy();
  barChart && barChart.destroy();

  // LINE CHART
  lineChart = new Chart(lc.getContext("2d"),{
    type:"line",
    data:{
      labels,
      datasets:[
        { label:"Flotta", data:fleet, borderColor:"#3b82f6", yAxisID:"y" },
        { label:"Costo totale", data:cost, borderColor:"#f87171", yAxisID:"y1" },
        { label:"Revenue", data:rev, borderColor:"#22c55e", yAxisID:"y1" }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:"index",intersect:false},
      scales:{
        x:{grid:{color:"rgba(148,163,184,0.1)"}},
        y:{
          beginAtZero:true,
          max:maxY1,
          ticks:{color:"#e5e7eb"},
          grid:{color:"rgba(148,163,184,0.1)"}
        },
        y1:{
          beginAtZero:true,
          max:maxY2,
          position:"right",
          grid:{drawOnChartArea:false},
          ticks:{color:"#e5e7eb"}
        }
      }
    }
  });

  // BAR CHART
  barChart = new Chart(bc.getContext("2d"),{
    type:"bar",
    data:{
      labels,
      datasets:[
        { label:"Costo totale", data:cost, backgroundColor:"rgba(248,113,113,0.5)" },
        { label:"Revenue", data:rev, backgroundColor:"rgba(34,197,94,0.5)" }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:"index",intersect:false},
      scales:{
        x:{grid:{color:"rgba(148,163,184,0.1)"}},
        y:{
          beginAtZero:true,
          max:maxY2,
          ticks:{color:"#e5e7eb"},
          grid:{color:"rgba(148,163,184,0.1)"}
        }
      }
    }
  });
}

// =========================
// EXPORT CSV
// =========================
function exportCsv(){
  if (!monthlyAggregates.length){
    alert("Nessun dato da esportare.");
    return;
  }
  const header = [
    "Anno","Mese","Label","FleetSize","CanoneImponibile","CanoneIvato",
    "Assicurazione","CostoTotale","Revenue","RevenuePerDay",
    "NumBookings","Noleggiati"
  ];

  const rows = monthlyAggregates.map(b=>[
    b.year,b.month,b.label,b.fleetSize,b.canoneImponibile,b.canoneIvato,
    b.assicurazione,b.costoTotale,b.revenue,b.revenuePerDay,
    b.numBookings,b.noleggiati
  ]);

  let csv = header.join(";")+"\n";
  rows.forEach(r=> csv+=r.join(";")+"\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="dashboard_fleet_bookings.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>
