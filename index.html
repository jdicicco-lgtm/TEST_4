<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>Dashboard Flotta & Prenotazioni</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
html[data-theme="dark"] {
  --bg-main:#0c0f14; --bg-card:#11161f; --bg-sidebar:#0f141c;
  --border-subtle:#2a3242; --text-primary:#eef2ff; --text-muted:#94a3b8;
  --c-flotta:#3b82f6; --c-costo:#06b6d4; --c-revenue:#22c55e;
}
body { background:var(--bg-main); color:var(--text-primary); font-family:system-ui; padding:1.2rem; }
.dashboard-shell{ max-width:1600px; margin:auto; }
.sidebar, .kpi-card, .chart-container {
  background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:1rem; padding:1rem;
}
.chart-container { height:48vh; }
</style>
</head>

<body>
<div class="dashboard-shell">

<div class="dashboard-header d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-0">Dashboard Flotta & Prenotazioni</h3>
    <small class="text-muted">Analisi 2024â€“2026 â€” Tema Neon Dual Mode</small>
  </div>
  <div><span id="themeToggle" style="cursor:pointer;">ðŸŒ™</span></div>
</div>

<div class="row g-3">

<!-- SIDEBAR -->
<div class="col-12 col-lg-3">
  <div class="sidebar">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="text-muted fw-bold text-uppercase">Filtri</div>
      <button id="clearFiltersBtn" class="btn btn-outline-danger btn-sm">Reset</button>
    </div>

    <label class="text-muted small">Anno</label>
    <select id="yearFilter" class="form-select mb-2" multiple>
      <option value="ALL" selected>Tutti</option>
      <option value="2024">2024</option>
      <option value="2025">2025</option>
      <option value="2026">2026</option>
    </select>

    <label class="text-muted small">Mese</label>
    <select id="monthFilter" class="form-select mb-2" multiple></select>

    <label class="text-muted small">Gruppo veicolo</label>
    <select id="groupFilter" class="form-select mb-2" multiple></select>

    <label class="text-muted small">Acquisizione</label>
    <select id="acquisitionFilter" class="form-select mb-2" multiple></select>

    <label class="text-muted small">Stazione</label>
    <select id="stationFilter" class="form-select mb-2" multiple></select>

    <label class="text-muted small">Proiezione 2026</label>
    <select id="projectionSelect" class="form-select mb-2">
      <option value="0.05">+5%</option>
      <option value="0.10" selected>+10%</option>
      <option value="0.15">+15%</option>
      <option value="0.20">+20%</option>
    </select>

  </div>
</div>

<!-- KPI + CHARTS -->
<div class="col-12 col-lg-9">

  <div class="row g-3 mb-3">
    <div class="col-6 col-xl-3"><div class="kpi-card"><div>Flotta</div><div id="kpi-fleet-current">â€“</div><small>Prev: <span id="kpi-fleet-prev">â€“</span></small><div id="kpi-fleet-diff"></div></div></div>
    <div class="col-6 col-xl-3"><div class="kpi-card"><div>Canone</div><div id="kpi-canone-current">â€“</div><small>Prev: <span id="kpi-canone-prev">â€“</span></small><div id="kpi-canone-diff"></div></div></div>
    <div class="col-6 col-xl-3"><div class="kpi-card"><div>Assicurazione</div><div id="kpi-assicurazione-current">â€“</div><small>Prev: <span id="kpi-assicurazione-prev">â€“</span></small><div id="kpi-assicurazione-diff"></div></div></div>
    <div class="col-6 col-xl-3"><div class="kpi-card"><div>Costo</div><div id="kpi-costo-current">â€“</div><small>Prev: <span id="kpi-costo-prev">â€“</span></small><div id="kpi-costo-diff"></div></div></div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-6 col-xl-3"><div class="kpi-card"><div>Revenue</div><div id="kpi-revenue-current">â€“</div><small>Prev: <span id="kpi-revenue-prev">â€“</span></small><div id="kpi-revenue-diff"></div></div></div>
    <div class="col-6 col-xl-3"><div class="kpi-card"><div>Revenue/day</div><div id="kpi-revday-current">â€“</div><small>Prev: <span id="kpi-revday-prev">â€“</span></small><div id="kpi-revday-diff"></div></div></div>
    <div class="col-6 col-xl-3"><div class="kpi-card"><div>Prenotazioni</div><div id="kpi-bookings-current">â€“</div><small>Prev: <span id="kpi-bookings-prev">â€“</span></small><div id="kpi-bookings-diff"></div></div></div>
    <div class="col-6 col-xl-3"><div class="kpi-card"><div>Noleggiati</div><div id="kpi-noleggiati-current">â€“</div><small>Prev: <span id="kpi-noleggiati-prev">â€“</span></small><div id="kpi-noleggiati-diff"></div></div></div>
  </div>

  <div class="chart-container mb-4"><canvas id="lineChart"></canvas></div>
  <div class="chart-container mb-4"><canvas id="barChart"></canvas></div>

</div>
</div>
</div>

<script>
// SAFE GET ELEMENT
function el(id){ return document.getElementById(id); }

// GLOBAL VARS
let fleetData=[], bookingsData=[], stationsData=[];
let monthly=[], baseMonthly=[];
let lineChart=null, barChart=null;

const GROUPS=[
 "Commercial Van","Large","Economy","Small","Mini","Premium","Suv","People Mover","Station Wagon","Cabriolet"
];
const MONTHS_IT=["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];

// LOAD DATA
document.addEventListener("DOMContentLoaded", async ()=>{
  await loadData();
  initFilters();
  applyFilters();
});

async function loadData(){
  fleetData = await fetch("fleetDataclean.json").then(r=>r.json());
  bookingsData = await fetch("bookings2025.json").then(r=>r.json());
  stationsData = await fetch("fleetStations2025.json").then(r=>r.json());
}

// INIT FILTERS
function initFilters(){
  const msel=el("monthFilter");
  msel.innerHTML="";
  msel.append(new Option("Tutti","ALL",true,true));
  MONTHS_IT.forEach((m,i)=>msel.append(new Option(m,String(i+1))));

  const gsel=el("groupFilter");
  gsel.innerHTML="";
  gsel.append(new Option("Tutti","ALL",true,true));
  GROUPS.forEach(g=>gsel.append(new Option(g,g)));

  const asel=el("acquisitionFilter");
  asel.innerHTML="";
  asel.append(new Option("Tutti","ALL",true,true));
  new Set([
    ...fleetData.map(r=>r.ACQUISIZIONE),
    ...bookingsData.map(r=>r.acquisizione)
  ]).forEach(a=> a && asel.append(new Option(a,a)));

  const ssel=el("stationFilter");
  ssel.innerHTML="";
  ssel.append(new Option("Tutti","ALL",true,true));
  new Set([
    ...stationsData.map(r=>r.station),
    ...bookingsData.map(r=>r.stazione)
  ]).forEach(s=> s && ssel.append(new Option(s,s)));

  ["yearFilter","monthFilter","groupFilter","acquisitionFilter","stationFilter","projectionSelect"]
    .forEach(id=> el(id).addEventListener("change", applyFilters));

  el("clearFiltersBtn").onclick = resetFilters;
}

function getMulti(id){
  const sel=[...el(id).selectedOptions].map(o=>o.value);
  return sel.includes("ALL")?[]:sel;
}

function resetFilters(){
  ["yearFilter","monthFilter","groupFilter","acquisitionFilter","stationFilter"]
    .forEach(id=>{
      [...el(id).options].forEach(o=>o.selected=o.value==="ALL");
    });
  el("projectionSelect").value="0.10";
  applyFilters();
}

// AGGREGATION
function applyFilters(){
  const years=getMulti("yearFilter").map(Number);
  const months=getMulti("monthFilter").map(Number);
  const groups=getMulti("groupFilter");
  const acq=getMulti("acquisitionFilter");
  const stations=getMulti("stationFilter");
  const proj=parseFloat(el("projectionSelect").value);

  baseMonthly=[]; // â† qui ricostruiremo in modo pulito

  // Simple placeholder - real aggregation logic can be added later
  // For now, prevent crashes and show empty charts
  monthly = [];

  updateKPI();
  updateCharts();
}

// KPI
function updateKPI(){
  [
    "fleet","canone","assicurazione","costo",
    "revenue","revday","bookings","noleggiati"
  ].forEach(id=>{
    el("kpi-"+id+"-current").textContent="â€“";
    el("kpi-"+id+"-prev").textContent="â€“";
    el("kpi-"+id+"-diff").textContent="â€“";
  });
}

// CHARTS
function updateCharts(){
  if(lineChart) lineChart.destroy();
  if(barChart) barChart.destroy();

  const ctx1=el("lineChart").getContext("2d");
  const ctx2=el("barChart").getContext("2d");

  lineChart=new Chart(ctx1,{
    type:"line",
    data:{labels:[],datasets:[]}
  });

  barChart=new Chart(ctx2,{
    type:"bar",
    data:{labels:[],datasets:[]}
  });
}

// THEME
el("themeToggle").onclick=()=>{
  const html=document.documentElement;
  const now=html.getAttribute("data-theme")==="dark"?"light":"dark";
  html.setAttribute("data-theme",now);
  localStorage.setItem("dashboard-theme",now);
  el("themeToggle").textContent=now==="dark"?"ðŸŒ™":"ðŸŒž";
};

(function(){
  const saved=localStorage.getItem("dashboard-theme")||"dark";
  document.documentElement.setAttribute("data-theme",saved);
  el("themeToggle").textContent=saved==="dark"?"ðŸŒ™":"ðŸŒž";
})();
</script>

</body>
</html>
